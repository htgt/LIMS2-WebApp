#
# High-level dockerfile
#

#
# Base image: LIMS2 low-level docker image
FROM sci/lims2:xenial

#
# System updates
RUN apt-get update && apt-get upgrade -y

#
# Creating directories
RUN mkdir -p /opt/sci/global/software/lims2/lib /opt/sci/global/conf/lims2/ /opt/sci/global/conf/bashrc/ /opt/sci/global/scripts/ /opt/sci/local/report_cache/lims2_cache_fp_report/localhost/ /nfs/sci/farm/conf/primers/ /var/lims2/logs/ /data/ /home/ubuntu/bwa_dump/

#
# Copy config files
COPY LIMS2-WebApp-filesystem/bashrc/bash_utils.sh /opt/sci/global/scripts/
COPY LIMS2-WebApp-filesystem/fcgi/fastcgi.yaml /opt/sci/global/conf/lims2/
COPY LIMS2-WebApp-filesystem/fcgi/lims2.conf /etc/apache2/sites-available/
COPY LIMS2-WebApp-filesystem/bashrc/* /opt/sci/global/conf/bashrc/
COPY LIMS2-WebApp-filesystem/lims2_conf/lims2/* /opt/sci/global/conf/lims2/
COPY LIMS2-WebApp-filesystem/lims2_conf/* /opt/sci/global/conf/
COPY LIMS2-WebApp-filesystem/farm/primers/ /nfs/sci/farm/conf/primers/
COPY LIMS2-WebApp-filesystem/farm/lims2-live-rest-client.conf /nfs/sci/farm/conf/
COPY LIMS2-WebApp-filesystem/farm/wge-live-rest-client.conf /nfs/sci/farm/conf/

#
# Enable apache rewrite
RUN a2enmod rewrite && a2ensite lims2

#
# Clone the git repos
RUN git clone https://github.com/htgt/WebApp-Common.git /tmp/WebApp-Common && \
  git clone https://github.com/htgt/Design-Creation.git /tmp/Design-Creation && \
  git clone https://github.com/htgt/Eng-Seq-Builder.git /tmp/Eng-Seq-Builder && \
  git clone https://github.com/htgt/HTGT-Admin-Utils.git /tmp/HTGT-Admin-Utils && \
  git clone https://github.com/htgt/Dist-Zilla-PluginBundle-Author-HTGT.git /tmp/Dist-Zilla-PluginBundle-Author-HTGT && \
  git clone https://github.com/htgt/LIMS2-REST-Client.git /tmp/LIMS2-REST-Client && \
  git clone https://github.com/htgt/LIMS2-Tasks.git /tmp/LIMS2-Tasks && \
  git clone https://github.com/htgt/LIMS2-WebApp.git /tmp/LIMS2-WebApp && \
  git clone https://github.com/htgt/LIMS2-Utils.git /tmp/LIMS2-Utils && \
  git clone https://github.com/htgt/HTGT-QC-Common.git /tmp/HTGT-QC-Common && \
  git clone https://github.com/htgt/LIMS2-Exception.git /tmp/LIMS2-Exception && \
  git clone https://github.com/fschwach/Bio-Tools-Primer3Redux.git /tmp/Bio-Tools-Primer3Redux && \
  git clone https://github.com/Ensembl/ensembl.git /tmp/ensembl && \
  cp -r  /tmp/WebApp-Common/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r  /tmp/WebApp-Common/shared_templates /opt/sci/global/software/lims2/lib/WebAppCommon/ && \
  cp -r /tmp/Design-Creation/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/Eng-Seq-Builder/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/HTGT-Admin-Utils/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/Dist-Zilla-PluginBundle-Author-HTGT/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/LIMS2-REST-Client/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/LIMS2-Tasks/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/LIMS2-WebApp/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/LIMS2-Utils/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/HTGT-QC-Common/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/LIMS2-Exception/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/Bio-Tools-Primer3Redux/lib/* /opt/sci/global/software/lims2/lib/ && \
  cp -r /tmp/ensembl/modules/Bio/* /opt/sci/global/software/lims2/lib/Bio/ && \
  rm -rf /tmp/WebApp-Common && \
  rm -rf /tmp/Design-Creation && \
  rm -rf /tmp/Eng-Seq-Builder && \
  rm -rf /tmp/HTGT-Admin-Utils && \
  rm -rf /tmp/Dist-Zilla-PluginBundle-Author-HTGT && \
  rm -rf /tmp/LIMS2-REST-Client && \
  rm -rf /tmp/LIMS2-Tasks && \
  rm -rf /tmp/LIMS2-WebApp && \
  rm -rf /tmp/LIMS2-Utils && \
  rm -rf /tmp/HTGT-QC-Common && \
  rm -rf /tmp/LIMS2-Exception && \
  rm -rf /tmp/Bio-Tools-Primer3Redux && \
  rm -rf /tmp/ensembl

#
# Change dependency path permissions
RUN chmod -R 755 /usr/local/share/perl/5.22.1/ && \
  chmod -R 755 /opt/sci/global/software/lims2/lib/ && \
  chmod -R 777 /opt/sci/local/report_cache/lims2_cache_fp_report/localhost/

#
# Install BWA
RUN cd /opt/sci/global/software/ && \
  git clone https://github.com/lh3/bwa.git && \
  cd bwa && \
  make

#
# Create new user
RUN adduser user && usermod -aG sudo user && \
  echo "user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

#
# Define the default user to run the commands
USER user

#
# Create the user-level configs
RUN mkdir -p /home/user/conf/LIMS2-WebApp/ /home/user/LIMS2-tmp/ /home/user/var/tmp/lims2/run/ /var/tmp/LIMS2-tmp-user /var/tmp/LIMS2-tmp-user/lims2_primer_generation /home/user/.ssh

COPY LIMS2-WebApp-filesystem/user/ssh_config /home/user/.ssh/config
COPY LIMS2-WebApp-filesystem/user/lims2_local /home/user/.lims2_local
COPY LIMS2-WebApp-filesystem/user/dbconnect.yaml /opt/sci/global/conf/lims2/dbconnect.yaml
COPY LIMS2-WebApp-filesystem/LIMS2-tmp/* /home/user/LIMS2-tmp/
COPY LIMS2-WebApp-filesystem/front_page_reports/* /opt/sci/local/report_cache/lims2_cache_fp_report/localhost/

#
# Clone the LIMS2-WebApp repo
RUN mkdir /home/user/git_checkout && cd /home/user/git_checkout && git clone https://github.com/htgt/LIMS2-WebApp.git

#
# Define a default working directory
WORKDIR /home/user/git_checkout/LIMS2-WebApp

#
# temp executions
COPY LIMS2-WebApp-filesystem/lims2_conf/lims2_webapp.sh /home/user/git_checkout/LIMS2-WebApp/script/lims2_webapp.sh

#
# Set up the environemnt and allow webapp launch with FCGI
CMD ["/home/user/git_checkout/LIMS2-WebApp/script/lims2_webapp.sh"]



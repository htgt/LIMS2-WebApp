FROM sci/lims2:fs

ARG database=LIMS2_TEST_USER

ENV LIMS2_DB=$database \
    LIMS2_DBCONNECT_CONFIG=/opt/sci/global/conf/lims2/dbconnect.yaml \
    PERL5LIB=/home/user/git_checkout/LIMS2-WebApp/lib:/opt/sci/global/software/lims2/lib/ \
    USER=user

ARG file_api_url

# Got by diffing the output of printenv for web_app and test
# Note that some envars that pointed to config files have been removed to avoid leaking production config in to dev/test.
# Of those that are left:
# HTGT_QC_CONF=/opt/sci/global/conf/qc.conf - just contains gene sequence related data.
# LIMS2_IMITS_CONN_CONFIG=/opt/sci/global/conf/lims2_imits_conn.conf - This is needed for
# the LIMS2::Model::Util::CreKiESDistribution module. It seems that that host listed in the
# config file no longer exists. The tests need a config file to run, but it seems that there
# is no actual database coneection made - as proved by changing the values in the config
# file to nonsense. The whole package under test can probably be removed, but for now we will
# continue using this config.
# According to Joel: iMits is a public tracking system for mouse experiments. It used to be in-house
# but Sanger has since sent it off (I think EBI manages it now) and Sanger no longer does mouse stuff.
# So this'll be gone and the mouse bit at least won't be coming back.
# LIMS2_LOG4PERL_CONFIG=/opt/sci/global/conf/lims2/log4perl.default.conf - Just basic logging config.
# LIMS2_PRIMER3_CRISPR_SEQUENCING_PRIMER_CONFIG=/nfs/sci/farm/conf/primers/primer3_crispr_sequencing_config.yaml
# - Bio-informatics related config.
# LIMS2_PRIMER3_MISEQ_PCR_CONFIG=/nfs/sci/farm/conf/primers/primer3_pcr_crispr_miseq_config.yaml
# - Bio-informatics related config.
# LIMS2_REST_CLIENT_CONFIG=/nfs/sci/farm/conf/lims2-live-rest-client.conf - This is needed by
# t/LIMS2/Model/Util/10_LIMS2_Model_Util_MiseqImport.t - due to the MiseqImport using
# WepAppCommon::Util::Jobrunner. Although the env-var neds to be set, the file pointed to doesn't need to
# exist (to get the tests to pass)
ENV DEFAULT_CRISPR_ES_QC_DIR=/tmp/lims2_crispr_es_qc \
    FILE_API_URL=$file_api_url \
    HTGT_QC_CONF=/opt/sci/global/conf/qc.conf \
    LIMS2_IMITS_CONN_CONFIG=/opt/sci/global/conf/lims2_imits_conn.conf \
    LIMS2_LOG4PERL_CONFIG=/opt/sci/global/conf/lims2/log4perl.default.conf \
    LIMS2_MISEQ_PROCESS_PATH=/lustre/scratch117/sciops/team87/MiSeq \
    LIMS2_MISEQ_RAW_PATH=/warehouse/team229_wh01/illumina_managed_miseq_archive/miseq_import \
    LIMS2_MISEQ_SCRIPTS_PATH=/nfs/team87/farm5/software/LIMS2-Scripts/bin \
    LIMS2_MISEQ_STORAGE_PATH=/warehouse/team229_wh01/lims2_managed_miseq_data/miseq_import \
    LIMS2_PRIMER3_CRISPR_SEQUENCING_PRIMER_CONFIG=/nfs/sci/farm/conf/primers/primer3_crispr_sequencing_config.yaml \
    LIMS2_PRIMER3_MISEQ_PCR_CONFIG=/nfs/sci/farm/conf/primers/primer3_pcr_crispr_miseq_config.yaml \
    LIMS2_PRIMER_SELECTION_DIR=/tmp/ \
    LIMS2_REST_CLIENT_CONFIG=/this/file/does/not/exist.conf \
    LIMS2_SEQ_ARCHIVE_DIR=/warehouse/team229_wh01/eurofins_order_archive_data \
    LIMS2_SEQ_FILE_DIR=/warehouse/team229_wh01/lims2_managed_sequencing_data \
    LIMS2_SHARED=/home/user/git_checkout \
    PERL_LWP_ENV_PROXY=1 \
    VEP_CACHE_DIR=/nfs/sci/vep_cache

# Adding by analysing failed tests
# ENG_SEQ_BUILDER_CONF is different for dev/prod
ENV ENG_SEQ_BUILDER_CONF=/opt/sci/global/conf/eng-seq-builder.devel.yaml

# Skipped due to 'WGE inaccessible from deployment environment'.
ENV SKIP_WGE_IMPORT_TESTS=1

# Following previous ansible configuration
ENV LIMS2_ALLELE_DET_CONFIG=/opt/sci/global/conf/allele_determination.conf

# Stub just to 'Odd number of elements in anonymous hash' error
ENV BASESPACE_TOKEN=12345

# Got by seeing Beth's fix - http://htgt1.internal.sanger.ac.uk:4005/issues/12689
ENV CRISPR_SEQUENCING_PRIMER_CONFIG=/nfs/sci/farm/conf/primers/crispr_sequencing_primer_conf.yaml \
    MGP_RECOVERY_GENOTYPING_PRIMER_CONFIG=/nfs/sci/farm/conf/primers/mgp_recovery_genotyping.yaml \
    CRISPR_PCR_PRIMER_CONFIG=/nfs/sci/farm/conf/primers/crispr_pcr_primer_conf.yaml \
    DESIGN_GENOTYPING_PRIMER_CONFIG=/nfs/sci/farm/conf/primers/design_genotyping_primer_conf.yaml

WORKDIR /home/user/git_checkout/LIMS2-WebApp
SHELL ["/bin/bash", "-c"]

# We have to reset the PERL5LIB env-var here as it is sset in lims2_setup.sh.
CMD source bin/lims2_setup.sh && \
    lims2 replicate test && \
    lims2 test && \
    export PERL5LIB=/home/user/git_checkout/LIMS2-WebApp/lib:/opt/sci/global/software/lims2/lib/ && \
    prove -lvr /home/user/git_checkout/LIMS2-WebApp/t
